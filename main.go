package main

import (
	"Avocycle/config"
	"Avocycle/models"
	"Avocycle/routes"
	"context"
	"fmt"
	"log"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"
)

func main() {
	// === 1Ô∏è‚É£ Connect ke PostgreSQL ===
	db, err := config.DbConnect()
	if err != nil {
		log.Fatalf("‚ùå Failed to connect to database: %v", err)
	}

	sqlDB, err := db.DB()
	if err != nil {
		log.Fatalf("‚ùå Failed to get underlying DB instance: %v", err)
	}

	if err := sqlDB.Ping(); err != nil {
		log.Fatalf("‚ùå Database ping failed: %v", err)
	}

	fmt.Println("========================================")
	fmt.Println("‚úÖ Connected to PostgreSQL database (LARAGON)")
	fmt.Println("========================================")

	// === 2Ô∏è‚É£ Auto migrate semua model ===
	if err := db.AutoMigrate(
		&models.User{},
		&models.Tanaman{},
		&models.ProsesProduksi{},
		&models.PersonalAccessTokens{},
		&models.PerawatanPenyakit{},
		&models.PenyakitTanaman{},
		&models.LogProsesProduksi{},
		&models.LogPenyakitTanaman{},
		&models.Kebun{},
		&models.Buah{},
		&models.Booking{},
	); err != nil {
		log.Fatalf("‚ùå Failed to auto migrate models: %v", err)
	}

	fmt.Println("========================================")
	fmt.Println("‚úÖ Database migration completed successfully")
	fmt.Println("========================================")

	// === 3Ô∏è‚É£ Inisialisasi routes ===
	router := routes.InitRoutes()

	// === 4Ô∏è‚É£ Jalankan server (dengan graceful shutdown) ===
	srv := &http.Server{
		Addr:    ":2005",
		Handler: router,
	}

	// Jalankan server di goroutine agar bisa ditutup dengan graceful shutdown
	go func() {
		fmt.Println("üöÄ Server is running on http://localhost:2005")
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatalf("‚ùå Server error: %v", err)
		}
	}()

	// === 5Ô∏è‚É£ Graceful shutdown (Ctrl+C atau kill signal) ===
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
	<-quit // tunggu sinyal berhenti

	fmt.Println("\nüõë Shutting down server gracefully...")

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	if err := srv.Shutdown(ctx); err != nil {
		log.Fatalf("‚ùå Server forced to shutdown: %v", err)
	}

	if err := sqlDB.Close(); err != nil {
		log.Printf("‚ö†Ô∏è  Failed to close DB connection: %v", err)
	} else {
		fmt.Println("‚úÖ Database connection closed.")
	}

	fmt.Println("üëã Server stopped cleanly.")
}
